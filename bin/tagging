#!/usr/bin/env ruby
$LOAD_PATH.unshift File.expand_path('../../lib', __FILE__)

require 'optparse'
require 'tagging/app_version'
require 'tagging/gem_version'

module Tagging
  class CLI
    def self.run(*args)
      if options[:push]
        puts Tagging::AppVersion.increment_and_push #rescue exit 1
        exit 0
      elsif options[:version]
        puts Tagging::AppVersion.version #rescue exit 1
        exit 0
      elsif options[:next_version]
        puts Tagging::AppVersion.increment_version #rescue exit 1
        exit 0
      else
        puts "## [message] Run `tagging --help' for more options."
      end
    end

    def self.options
      options = {}
      opt_parser = OptionParser.new do |opt|
        opt.banner = "Usage: tagging [OPTIONS]"
        opt.separator  ""
        opt.separator  "Options"

        opt.on("-p","--push","Increment version and push to tag") do |value|
          options[:push] = value
        end

        opt.on("-v","--version","Show current version into rails app path") do |value|
          options[:version] = value
        end
        
        opt.on("-n","--next_version","Show the next version") do |value|
          options[:next_version] = value
        end

        opt.on("-h","--help","help") do
          puts opt_parser
          exit
        end
      end
      opt_parser.parse!

      self.options_verify?(options)
      
      return options
    end

    def self.options_verify?(op)
      if [op[:push], op[:version], op[:next_version]].compact.length > 1
        warn("[fail] Can only push, version or next_version. Choose one.")
        exit(1)
      end
    end
  end
end

Tagging::CLI.run(ARGV)